angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$timeout","$locale",function(n,e,r){var a=n.eventSources,t=n.calendarWatchEvent?n.calendarWatchEvent:angular.noop,l=function(n){var r;return n&&(r=function(){var r=arguments,a=this;e(function(){n.apply(a,r)})}),r},o=1;this.eventFingerprint=function(n){return n._id||(n._id=o++),""+n._id+(n.id||"")+(n.title||"")+(n.url||"")+(+n.start||"")+(+n.end||"")+(n.allDay||"")+(n.className||"")+t(n)||""};var u=1,i=1;this.sourceFingerprint=function(n){var e=""+(n.__id||(n.__id=u++)),r=angular.isObject(n)&&n.events;return r&&(e=e+"-"+(r.__id||(r.__id=i++))),e},this.allEvents=function(){for(var n=[],e=0,r=a.length;r>e;e++){var t=a[e];if(angular.isArray(t))n.push(t);else if(angular.isObject(t)&&angular.isArray(t.events)){var l={};for(var o in t)"_id"!==o&&"events"!==o&&(l[o]=t[o]);for(var u=0;u<t.events.length;u++)angular.extend(t.events[u],l);n.push(t.events)}}return Array.prototype.concat.apply([],n)},this.changeWatcher=function(n,e){var r,a=function(){for(var r,a,t=angular.isFunction(n)?n():n,o=[],u=0,i=t.length;i>u;u++)a=t[u],r=e(a),l[r]=a,o.push(r);return o},t=function(n,e){var r,a,t=[],l={};for(r=0,a=e.length;a>r;r++)l[e[r]]=!0;for(r=0,a=n.length;a>r;r++)l[n[r]]||t.push(n[r]);return t},l={},o=function(n,a){var o,u,i,c,d={},f=t(a,n);for(o=0,u=f.length;u>o;o++){var s=f[o];i=l[s],delete l[s];var v=e(i);v===s?r.onRemoved(i):(d[v]=s,r.onChanged(i))}var g=t(n,a);for(o=0,u=g.length;u>o;o++)c=g[o],i=l[c],d[c]||r.onAdded(i)};return r={subscribe:function(n,e){n.$watch(a,function(n,r){var a=!(e&&e(n,r)===!1);a&&o(n,r)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(n,e){var r={};return angular.extend(r,e),angular.extend(r,n),angular.forEach(r,function(n,e){"function"==typeof n&&(r[e]=l(r[e]))}),r},this.getLocaleConfig=function(n){if(!n.lang||n.useNgLocale){var e=function(n){var e,r;e=[];for(r in n)e[r]=n[r];return e},a=r.DATETIME_FORMATS;return{monthNames:e(a.MONTH),monthNamesShort:e(a.SHORTMONTH),dayNames:e(a.DAY),dayNamesShort:e(a.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(n){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(e,r,a,t){function l(){var r,l=a.uiCalendar?e.$parent.$eval(a.uiCalendar):{};r=t.getFullCalendarConfig(l,n);var o=t.getLocaleConfig(r);angular.extend(o,r),f={eventSources:u},angular.extend(f,o),f.calendars=null;var i={};for(var c in f)"eventSources"!==c&&(i[c]=f[c]);return JSON.stringify(i)}var o,u=e.eventSources,i=!1,c=t.changeWatcher(u,t.sourceFingerprint),d=t.changeWatcher(t.allEvents,t.eventFingerprint),f=null;e.destroy=function(){o&&o.fullCalendar&&o.fullCalendar("destroy"),o=a.calendar?n.calendars[a.calendar]=$(r).html(""):$(r).html("")},e.init=function(){o.fullCalendar(f),a.calendar&&(n.calendars[a.calendar]=o)},c.onAdded=function(n){o.fullCalendar("addEventSource",n),i=!0},c.onRemoved=function(n){o.fullCalendar("removeEventSource",n),i=!0},c.onChanged=function(){o.fullCalendar("refetchEvents"),i=!0},d.onAdded=function(n){o.fullCalendar("renderEvent",n,n.stick?!0:!1)},d.onRemoved=function(n){o.fullCalendar("removeEvents",n._id)},d.onChanged=function(n){n._start=jQuery.fullCalendar.moment(n.start),n._end=jQuery.fullCalendar.moment(n.end),o.fullCalendar("updateEvent",n)},c.subscribe(e),d.subscribe(e,function(){return i===!0?(i=!1,!1):void 0}),e.$watch(l,function(){e.destroy(),e.init()})}}}]);